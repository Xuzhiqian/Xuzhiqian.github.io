<!doctype html>
<html>
<head>
　　<title>Objects编辑器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
 
 <script>
    var content;
    var reg = /\[[a-zA-Z0-9]+\]\r*\n*([a-zA-Z0-9]+\=\-?\d+\.?\d*\r*\n*)*\r*\n*/g;
    var reg_index = /\[([a-zA-Z0-9]+)\]/;
    var reg_props = /[a-zA-Z0-9]+\=\-?\d+\.?\d*\r*\n*/g;
    var reg_prop = /[a-zA-Z0-9]+/;
    var reg_value = /\-?\d+\.?\d*/;
    var models = [];
   function readLocalFile () {
        //alert("start...");
        var localFile = document.getElementById("uploadFile").files[0];
        //alert(uploadFile);
        //alert(localFile.name);
        //alert(localFile.type);
        //alert(localFile.size);
        var reader = new FileReader();
        //Uncaught SyntaxError:Unexpected identifier
        reader.onload = function(event) {
            content = event.target.result;
        }
        reader.onerror = function(event) {
         alert('error')
            //alert("File could not be read! Code " + event.target.error.code);
        }
        //reader.readAsText(localFile,"UTF-8");
        content = reader.readAsText(localFile,"UTF-8");
        //
    }
    function mainNew(models) {
        if (models['[new]']===undefined || models['[new]']===null) {
            models['[new]'] = [];
        }
    }
    function parseContent(content) {
        models = [];
        let models_raw = content.match(reg);
        models_raw.forEach((model)=>{
            let index = model.match(reg_index)[1];
            models[index] = [];
            model.match(reg_props).forEach((stmt)=>{
                models[index][stmt.match(reg_prop)[0]]=parseFloat(stmt.match(reg_value)[0]);
            });
        });
        mainNew(models);
        return models;
    }
    function edit(u) {
        if (u.childElementCount > 0) return;
        let value = u.innerHTML;
        u.innerHTML = "<input id='_" + u.id  + "' type='text' onblur='save(this)'/>";
        let _u = document.getElementById('_' + u.id);
        _u.value = value;
        _u.pre_value = value;
        _u.focus();
    }
    function save(_u) {
        let u = document.getElementById(_u.id.slice(1));
        r = _u.id.match(/\_?([a-zA-Z0-9]+)\_?([-.a-zA-Z0-9]+)?\_?([-.a-zA-Z0-9]+)?/);
        if (r[1] === 'i') {
            if (_u.value.length <= 0)
                delete models[_u.pre_value];
            else {
                models[_u.value] = models[_u.pre_value];
                if (_u.value !== _u.pre_value)
                    delete models[_u.pre_value];
            }
            mainNew(models);
            drawTable(models);
        }
        else if (r[1] === 'v') {
            models[r[2]][r[3]] = _u.value;
            u.innerHTML = _u.value;
        } 
    }
    function drawTable(models) {
        let th = "<th></th>";
        let th_name = [];
        let th_index = [];
        let th_num = 0;
        let trs = "";

        for (let index in models)
            for (let prop in models[index])
                if (!th_name[prop]) {
                    th_name[prop] = ++th_num;
                    th_index[th_num] = prop;
                    th = th + "<th id='p_" + prop + "'>" + prop + "</th>";
                }
        for (let index in models) {
            let m = models[index];
            let tr = [index];
            for (let prop in m)
                tr[th_name[prop]]=m[prop];

            trs = trs + "<tr><td id='i_" + index + "' onclick='edit(this)'>" + index + "</td>";
            for (let i=1; i<=th_num; i++)
                trs = trs + "<td id='v_" + index + '_' + th_index[i] + "' onclick='edit(this)'>" + (tr[i]!=undefined?tr[i]:'') + "</td>"; 
            trs = trs + "</tr>";     
        }
        document.getElementById("table").innerHTML = "<table border='1'><tr>" + th + "</tr>" + trs + "</table>";
    }
    function saveIni() {
        let s = '';
        for (let id in models) 
            if (id!=='[new]') {
            s = s + '[' + id + ']\n';
            for (let prop in models[id])
                if (models[id][prop]!=='')
                s = s + prop + '=' + models[id][prop] + '\n';
        }
        document.getElementById("ini").value = s;
    }
 </script>
  
    <section>
        <input type="file" id="uploadFile" onchange="readLocalFile()";/>
        <button id="parseBtn" onclick="drawTable(parseContent(content))">Parse</button>
        <button id="saveBtn" onclick="saveIni()">Save</button>
        <div id="table"></div>
        <textarea  id="ini" style="position:absolute;right:40px;top:40px;width:400px;"></textarea>
    </section>
     
</body>
</html>